<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的私人收藏馆</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* Custom Scrollbar for cleaner look */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal {
            transition: opacity 0.2s ease-in-out;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Mobile Optimization */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column;
            }
            .mobile-full {
                width: 100% !important;
            }
            .mobile-hide {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex overflow-hidden font-sans">

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 w-64 bg-slate-900 text-white flex flex-col shadow-xl z-30 transition-transform duration-300 ease-in-out">
        <div class="p-6 border-b border-slate-700 flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                藏品管理
            </h1>
            <button onclick="app.toggleSidebar()" class="md:hidden text-slate-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <nav class="flex-1 overflow-y-auto p-4 space-y-2">
            <div 
                onclick="app.setView('all', 'all')"
                class="cursor-pointer px-4 py-2 rounded hover:bg-slate-700 transition flex items-center justify-between group" 
                id="nav-all">
                <span class="flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    所有藏品
                </span>
                <span id="count-all" class="bg-slate-800 text-xs px-2 py-0.5 rounded-full text-slate-400 group-hover:text-white">0</span>
            </div>

            <div class="pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider flex justify-between items-center">
                <span>分类与资料夹</span>
                <button onclick="app.openFolderModal()" class="bg-amber-500 hover:bg-amber-400 text-white w-5 h-5 flex items-center justify-center rounded-full" title="新建资料夹">+</button>
            </div>
            
            <div id="sidebar-hierarchy" class="space-y-4">
                <!-- Hierarchy (Types > Folders) injected here -->
            </div>
        </nav>

        <div class="p-4 border-t border-slate-700 bg-slate-900">
            <button onclick="app.downloadHtml()" class="w-full flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 text-white py-2 px-4 rounded shadow transition font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                </svg>
                保存并下载数据
            </button>
            <div class="text-xs text-center text-slate-500 mt-2">
                点击保存下载最新数据文件
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        <!-- Top Bar -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 md:px-8 shadow-sm z-10 sticky top-0 shrink-0">
        <div class="flex items-center gap-2 md:gap-4">
            <button onclick="app.toggleSidebar()" class="md:hidden text-slate-500 hover:text-slate-800 mr-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800 truncate max-w-[120px] md:max-w-none">所有藏品</h2>
            <div class="h-6 w-px bg-slate-300 mx-1 md:mx-2 hidden md:block"></div>
            <div class="relative hidden md:block">
                <input type="text" id="search-input" oninput="app.handleSearch(this.value)" placeholder="搜索名称、编号..." 
                    class="pl-9 pr-4 py-1.5 border border-slate-300 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-amber-400 w-64">
                <svg class="w-4 h-4 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <!-- Mobile Search Icon Trigger (Optional implementation) -->
        </div>

        <div id="header-actions" class="flex items-center gap-2 md:gap-3">
                <button onclick="app.openTypeSettings()" class="text-slate-500 hover:text-slate-800 px-3 py-1.5 text-sm font-medium flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    设置类型
                </button>
                <input type="file" id="import-file" class="hidden" onchange="app.importData(this)">
                <button onclick="document.getElementById('import-file').click()" class="text-slate-500 hover:text-slate-800 px-3 py-1.5 text-sm font-medium">
                    导入数据
                </button>
                <button onclick="app.openItemModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-medium flex items-center gap-1 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    新增藏品
                </button>
            </div>
        </header>

        <!-- Batch Actions Bar (Hidden by default) -->
        <div id="batch-bar" class="bg-blue-50 border-b border-blue-100 px-8 py-2 flex items-center justify-between hidden">
            <div class="text-sm text-blue-800">
                已选择 <span id="selected-count" class="font-bold">0</span> 项
            </div>
            <div class="flex gap-2">
                <!-- Batch Type -->
                <select id="batch-type-select" class="text-sm border border-blue-200 rounded px-2 py-1 bg-white">
                    <option value="">-- 修改类型 --</option>
                </select>
                <button onclick="app.batchSetType()" class="text-sm bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded hover:bg-blue-100">应用</button>
                
                <div class="w-px bg-blue-200 mx-1"></div>

                <!-- Batch Folder -->
                <select id="batch-folder-select" class="text-sm border border-blue-200 rounded px-2 py-1 bg-white">
                    <option value="">-- 移动到 --</option>
                </select>
                <button onclick="app.batchMove()" class="text-sm bg-white border border-blue-200 text-blue-700 px-3 py-1 rounded hover:bg-blue-100">移动</button>
                
                <div class="w-px bg-blue-200 mx-1"></div>

                <button onclick="app.batchDelete()" class="text-sm bg-red-50 border border-red-200 text-red-700 px-3 py-1 rounded hover:bg-red-100">批量删除</button>
                <button onclick="app.clearSelection()" class="text-sm text-slate-500 px-3 py-1 hover:text-slate-800">取消</button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="flex-1 overflow-auto bg-slate-50 p-2 md:p-6">
            <div class="bg-white rounded-lg shadow overflow-hidden min-h-[400px] overflow-x-auto">
                <table class="w-full text-left border-collapse min-w-[1000px]">
                    <thead class="bg-slate-100 text-slate-600 text-xs uppercase tracking-wider sticky top-0 z-10">
                        <tr>
                            <th class="p-4 w-10 border-b border-slate-200">
                                <input type="checkbox" onchange="app.toggleSelectAll(this)" class="rounded text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="p-4 border-b border-slate-200 font-semibold">编号</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">图片</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">名称</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">面额/币种</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">类型</th>
                            <th class="p-4 border-b border-slate-200 font-semibold text-right">估价</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">生产/印刷日期</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">入库日期</th>
                            <th class="p-4 border-b border-slate-200 font-semibold">备注</th>
                            <th class="p-4 border-b border-slate-200 font-semibold text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
                <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-slate-400">
                    <svg class="w-16 h-16 mb-4 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                    <p>暂无数据</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Item Detail -->
    <div id="detail-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh] mx-4">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                <h3 class="font-bold text-lg text-slate-800" id="detail-title">藏品详情</h3>
                <button onclick="app.closeModal('detail-modal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Image Gallery -->
                <div id="detail-images" class="flex overflow-x-auto gap-4 mb-6 pb-2 scrollbar-thin">
                    <!-- Images injected here -->
                </div>

                <!-- Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                    <div class="space-y-4">
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">名称</span>
                            <span class="font-bold text-slate-800" id="detail-name">-</span>
                        </div>
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">编号</span>
                            <span class="font-mono text-slate-700" id="detail-code">-</span>
                        </div>
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">类型</span>
                            <span class="text-slate-700" id="detail-type">-</span>
                        </div>
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">资料夹</span>
                            <span class="text-slate-700" id="detail-folder">-</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                         <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">估价</span>
                            <span class="font-bold text-amber-600 font-mono" id="detail-price">-</span>
                        </div>
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">面额/币种</span>
                            <span class="text-slate-700" id="detail-value">-</span>
                        </div>
                         <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">生产日期</span>
                            <span class="text-slate-700" id="detail-prod-date">-</span>
                        </div>
                        <div class="flex border-b border-slate-100 pb-2">
                            <span class="text-slate-500 w-24 shrink-0">入库日期</span>
                            <span class="text-slate-700" id="detail-date">-</span>
                        </div>
                    </div>
                </div>

                <!-- Note -->
                <div class="mt-6 pt-4 border-t border-slate-100">
                    <span class="block text-slate-500 mb-2 text-xs uppercase tracking-wider font-bold">备注</span>
                    <p class="text-slate-700 bg-slate-50 p-4 rounded text-sm leading-relaxed whitespace-pre-wrap" id="detail-note"></p>
                </div>
            </div>
            
            <div class="p-4 border-t border-slate-100 bg-slate-50 text-right">
                <button onclick="app.closeModal('detail-modal')" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-800 rounded font-medium text-sm transition">关闭</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Item -->
    <div id="item-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl overflow-hidden transform transition-all scale-100 flex flex-col max-h-[90vh] mx-4 md:mx-0">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50 shrink-0">
                <h3 class="font-bold text-lg text-slate-800" id="item-modal-title">新增藏品</h3>
                <button onclick="app.closeModal('item-modal')" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            
            <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
                <!-- Left: Form -->
                <form id="item-form" onsubmit="app.saveItem(event)" class="w-full md:w-1/2 p-6 space-y-4 overflow-y-auto md:border-r border-slate-100">
                    <input type="hidden" id="item-id-hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">名称 <span class="text-red-500">*</span></label>
                            <input type="text" id="item-name" required class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">编号 (自动生成可修改)</label>
                            <input type="text" id="item-code" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">类型</label>
                            <select id="item-type" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <!-- Types injected -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">资料夹</label>
                            <select id="item-folder" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <!-- Folders injected -->
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">面额</label>
                            <input type="text" id="item-face-value" placeholder="例如: 100" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">币种</label>
                            <select id="item-currency" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <!-- Currencies injected -->
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">生产/印刷日期</label>
                            <input type="date" id="item-prod-date" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1">估价</label>
                            <input type="number" id="item-price" step="0.01" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">入库日期</label>
                        <input type="date" id="item-date" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-500 mb-1">备注</label>
                        <textarea id="item-note" rows="3" class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                    </div>

                    <div class="pt-4 flex justify-end gap-2 sticky bottom-0 bg-white pb-2">
                        <button type="button" onclick="app.closeModal('item-modal')" class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">取消</button>
                        <button type="submit" class="px-6 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-bold">保存藏品</button>
                    </div>
                </form>

                <!-- Right: Image Management -->
                <div class="w-full md:w-1/2 p-6 bg-slate-50 flex flex-col overflow-hidden border-t md:border-t-0 border-slate-100">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">图片管理 (最多 25 张)</label>
                        <div class="flex gap-2">
                            <input type="text" id="image-url-input" placeholder="输入图片 URL 地址..." class="flex-1 border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="app.addImageUrl()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-black transition">添加</button>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-1">请输入网络图片地址，系统会自动预览。</p>
                    </div>

                    <div id="image-preview-container" class="flex-1 overflow-y-auto grid grid-cols-3 gap-3 p-1">
                        <!-- Image thumbnails will appear here -->
                    </div>
                    
                    <div class="mt-4 pt-3 border-t border-slate-200 text-right">
                        <span id="image-counter" class="text-xs font-medium text-slate-500">已添加: 0 / 25</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Manage Folders -->
    <div id="folder-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h3 class="font-bold text-lg mb-4">新建资料夹</h3>
            <form onsubmit="app.saveFolder(event)" class="space-y-4">
                <input type="hidden" id="folder-id-hidden">
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">所属分类 <span class="text-red-500">*</span></label>
                    <select id="folder-parent-type" required class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <!-- Types injected here -->
                    </select>
                    <p class="text-[10px] text-slate-400 mt-1">请先选择一个分类，再建立资料夹</p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">资料夹名称 <span class="text-red-500">*</span></label>
                    <input type="text" id="folder-name" required class="w-full border border-slate-300 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-500 mb-1">描述 (可选)</label>
                    <input type="text" id="folder-desc" class="w-full border border-slate-300 rounded px-3 py-2 text-sm outline-none">
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="app.closeModal('folder-modal')" class="px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 rounded">取消</button>
                    <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 shadow">确定创建</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Login -->
    <div id="login-modal" class="modal fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 text-center mx-4">
            <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 text-blue-600">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">系统锁定</h2>
            <p class="text-slate-500 text-sm mb-6">请输入管理员密码以访问系统</p>
            <form onsubmit="app.handleLogin(event)" class="space-y-4">
                <input type="password" id="login-password" placeholder="请输入密码" class="w-full border border-slate-300 rounded px-4 py-2 text-center focus:ring-2 focus:ring-blue-500 outline-none transition">
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-bold shadow transition">进入系统</button>
            </form>
            <button onclick="app.closeModal('login-modal')" class="mt-4 text-sm text-slate-400 hover:text-slate-600">取消</button>
        </div>
    </div>

    <!-- Modal: Settings/Types -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-0 overflow-hidden flex flex-col max-h-[80vh] mx-4">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h3 class="font-bold text-lg text-slate-800">类型设置</h3>
                <button onclick="app.closeModal('settings-modal')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <div class="flex-1 overflow-auto p-6 space-y-8">
                <!-- Section 1: Types -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wider">类型设置</h4>
                    <form onsubmit="app.addType(event)" class="bg-slate-50 p-4 rounded border border-slate-200 mb-4 flex gap-3 items-start">
                        <div class="flex-1">
                            <input type="text" id="new-type-name" placeholder="类型名称 (如: 邮票)" required class="w-full border border-slate-300 rounded px-3 py-1.5 text-sm mb-2">
                            <input type="text" id="new-type-note" placeholder="备注 (可选)" class="w-full border border-slate-300 rounded px-3 py-1.5 text-sm">
                        </div>
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 mt-1">添加类型</button>
                    </form>
                    <div class="border border-slate-200 rounded overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3">名称</th>
                                    <th class="p-3">备注</th>
                                    <th class="p-3 w-20">操作</th>
                                </tr>
                            </thead>
                            <tbody id="type-list-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Section: Folders -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wider border-t pt-8">资料夹管理</h4>
                    <div class="border border-slate-200 rounded overflow-hidden mb-4 max-h-48 overflow-y-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th class="p-3">名称</th>
                                    <th class="p-3">所属分类</th>
                                    <th class="p-3 w-20 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="folder-list-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    <p class="text-xs text-slate-400 text-right mb-4">提示：新建资料夹请在侧边栏操作</p>
                </div>

                <!-- Section 2: Currencies -->
                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-2 uppercase tracking-wider border-t pt-8">币种设置</h4>
                    <form onsubmit="app.addCurrency(event)" class="bg-slate-50 p-4 rounded border border-slate-200 mb-4 flex gap-3 items-end">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-slate-500 mb-1">币种名称</label>
                            <input type="text" id="new-currency-name" placeholder="如: 人民币 (CNY)" required class="w-full border border-slate-300 rounded px-3 py-1.5 text-sm">
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">添加币种</button>
                    </form>
                    <div class="border border-slate-200 rounded overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="p-3">币种名称</th>
                                    <th class="p-3 w-20 text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="currency-list-body" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-100 text-right bg-slate-50">
                <button onclick="app.closeModal('settings-modal')" class="px-4 py-2 text-sm bg-slate-200 hover:bg-slate-300 rounded text-slate-800">关闭</button>
            </div>
        </div>
    </div>

    <!-- DATA STORAGE: This script tag holds the JSON data -->
    <script id="db-storage" type="application/json">
        {"items":[], "folders":[], "types":[{"id":"t1","name":"默认分类","note":""}], "currencies":[{"id":"c1","name":"人民币 (CNY)"},{"id":"c2","name":"美元 (USD)"},{"id":"c3","name":"欧元 (EUR)"}]}
    </script>

    <script>
        class App {
            constructor() {
                this.state = {
                    isAuthenticated: false,
                    items: [],
                    folders: [],
                    types: [],
                    currencies: [],
                    currentView: 'all',
                    currentViewType: 'all',
                    searchQuery: '',
                    selectedItems: new Set(),
                    tempImages: [] // Store images currently being edited in modal
                };
                this.init();
            }

            init() {
                this.loadData();
                // If clean slate, ensure defaults
                if (this.state.types.length === 0) {
                    this.state.types.push({id: 't1', name: '默认分类', note: '系统默认'});
                }
                if (this.state.currencies.length === 0) {
                    this.state.currencies = [
                        {id: 'c1', name: '人民币 (CNY)'},
                        {id: 'c2', name: '美元 (USD)'},
                        {id: 'c3', name: '港币 (HKD)'}
                    ];
                }
                this.renderAll();
                
                // Add event listener for keyboard escape to close modals
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
                    }
                });
            }

            // --- Auth & Mobile ---

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                // Check if hidden (default on mobile)
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }

            openLogin() {
                document.getElementById('login-password').value = '';
                document.getElementById('login-modal').classList.add('active');
                setTimeout(() => document.getElementById('login-password').focus(), 100);
            }

            handleLogin(e) {
                e.preventDefault();
                const pwd = document.getElementById('login-password').value;
                if (pwd === 'Carter0502') {
                    this.state.isAuthenticated = true;
                    this.closeModal('login-modal');
                    this.renderAll();
                } else {
                    alert('密码错误');
                    document.getElementById('login-password').value = '';
                }
            }

            logout() {
                this.state.isAuthenticated = false;
                this.state.selectedItems.clear();
                this.renderAll();
            }

            // --- Persistence ---

            loadData() {
                try {
                    // Priority 1: Embedded JSON (File Priority for Cross-Device)
                    // Checks if the file has meaningful embedded data (saved file)
                    const embedded = document.getElementById('db-storage').textContent;
                    let loadedFromEmbedded = false;
                    
                    if (embedded && embedded.trim().length > 0) {
                        try {
                            const parsed = JSON.parse(embedded);
                            // If it looks like a valid saved file (has items or user-defined folders/types)
                            if (parsed.items.length > 0 || parsed.folders.length > 0 || parsed.types.length > 1) {
                                this.state.items = parsed.items || [];
                                this.state.folders = parsed.folders || [];
                                this.state.types = parsed.types || [];
                                this.state.currencies = parsed.currencies || [];
                                console.log('Loaded from Embedded Data (File)');
                                loadedFromEmbedded = true;
                            }
                        } catch(e) { console.error('Embedded JSON parse error', e); }
                    }

                    // Priority 2: LocalStorage (Fallback for new templates or refreshes)
                    // Only use LS if we didn't load from Embedded (or Embedded was empty template)
                    if (!loadedFromEmbedded) {
                        const local = localStorage.getItem('cms_data');
                        if (local) {
                            const parsed = JSON.parse(local);
                            this.state.items = parsed.items || [];
                            this.state.folders = parsed.folders || [];
                            this.state.types = parsed.types || [];
                            this.state.currencies = parsed.currencies || [];
                            console.log('Loaded from LocalStorage');
                        }
                    }
                    
                    // Always sync to local storage after load so refresh works
                    this.saveToLocal();
                    
                } catch (e) {
                    console.error("Error loading data", e);
                }
            }

            saveToLocal() {
                const data = {
                    items: this.state.items,
                    folders: this.state.folders,
                    types: this.state.types,
                    currencies: this.state.currencies
                };
                localStorage.setItem('cms_data', JSON.stringify(data));
            }

            saveData() {
                this.saveToLocal();
                this.renderAll();
            }

            downloadHtml() {
                // 1. Prepare Data with safe script tags
                const dataStr = JSON.stringify({
                    items: this.state.items,
                    folders: this.state.folders,
                    types: this.state.types,
                    currencies: this.state.currencies
                }).replace(/<\/script>/g, '<\\/script>'); 

                // 2. Get HTML Source
                let html = document.documentElement.outerHTML;

                // 3. Clean Dynamic Content (Reduce file size & prevent ghost data)
                html = html.replace(/(<tbody id="table-body"[^>]*>)([\s\S]*?)(<\/tbody>)/, '$1\n<!-- Rows injected here -->\n$3');
                html = html.replace(/(<div id="folder-list"[^>]*>)([\s\S]*?)(<\/div>)/, '$1\n<!-- Folder items injected here -->\n$3');
                // Remove active classes from modals to ensure they start closed
                html = html.replace(/ class="modal[^"]*active"/g, ' class="modal"');

                // 4. Inject Data
                const regex = /(<script id="db-storage" type="application\/json">)([\s\S]*?)(<\/script>)/;
                if (regex.test(html)) {
                    html = html.replace(regex, `$1${dataStr}$3`);
                } else {
                    alert("保存失败：无法定位存储区域");
                    return;
                }

                // 5. Download
                const blob = new Blob([html], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `藏品管理_${new Date().toISOString().slice(0,10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            importData(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        // Merge strategies? For now, simple append or replace. Let's ask.
                        // Assuming simple replace or smart merge. Let's do smart merge based on ID.
                        // Actually prompt implies "Import data", usually means restore.
                        if(confirm('导入将覆盖当前数据(如果文件是JSON) 或 合并(如果是系统生成的HTML)? \n\n点击确定尝试读取数据。')) {
                             // Logic handles generic JSON or our HTML structure
                            let data = json; // assumes pure JSON
                            
                            // If user uploaded the HTML file
                            if (typeof json !== 'object' && e.target.result.includes('<!DOCTYPE html>')) {
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(e.target.result, 'text/html');
                                const scriptContent = doc.getElementById('db-storage').textContent;
                                data = JSON.parse(scriptContent);
                            }
                            
                            if (data.items && data.folders) {
                                this.state.items = data.items;
                                this.state.folders = data.folders;
                                this.state.types = data.types || [];
                                this.saveData();
                                alert('数据导入成功！');
                            }
                        }
                    } catch (err) {
                        alert('导入失败，文件格式不正确');
                    }
                };
                // Try reading as text (JSON or HTML)
                reader.readAsText(file);
                input.value = ''; // reset
            }

            // --- Rendering ---

            renderAll() {
                this.renderSidebar();
                this.renderTable();
                this.renderStats();
                this.renderHeaderControls();
            }

            renderHeaderControls() {
                const actionsDiv = document.getElementById('header-actions');
                if (!this.state.isAuthenticated) {
                    actionsDiv.innerHTML = `
                        <button onclick="app.openLogin()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-bold flex items-center gap-2 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path></svg>
                            进入系统
                        </button>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <button onclick="app.openTypeSettings()" class="flex text-slate-500 hover:text-slate-800 px-2 md:px-3 py-1.5 text-sm font-medium items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span class="hidden md:inline">设置类型</span>
                        </button>
                        <input type="file" id="import-file" class="hidden" onchange="app.importData(this)">
                        <button onclick="document.getElementById('import-file').click()" class="hidden md:block text-slate-500 hover:text-slate-800 px-3 py-1.5 text-sm font-medium">
                            导入数据
                        </button>
                        <button onclick="app.openItemModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow text-sm font-medium flex items-center gap-1 transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            新增藏品
                        </button>
                        <button onclick="app.logout()" class="text-slate-400 hover:text-red-500 px-2" title="退出系统">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    `;
                }
            }

            renderSidebar() {
                const container = document.getElementById('sidebar-hierarchy');
                container.innerHTML = '';
                
                // Auth Controls in Sidebar
                const addFolderBtn = document.querySelector('button[title="新建资料夹"]');
                if(addFolderBtn) addFolderBtn.style.display = this.state.isAuthenticated ? 'flex' : 'none';
                
                const downloadSection = document.querySelector('aside .border-t');
                if(downloadSection) downloadSection.style.display = this.state.isAuthenticated ? 'block' : 'none';

                this.state.types.forEach(type => {
                    const typeFolders = this.state.folders.filter(f => f.typeId === type.id);
                    const isTypeActive = this.state.currentView === type.id && this.state.currentViewType === 'type';
                    
                    const typeDiv = document.createElement('div');
                    typeDiv.className = "space-y-1";
                    
                    // Type Header
                    const typeHeader = document.createElement('div');
                    typeHeader.className = `px-2 py-1.5 rounded text-sm font-semibold flex items-center justify-between cursor-pointer transition ${isTypeActive ? 'bg-slate-700 text-amber-400' : 'text-slate-400 hover:text-white'}`;
                    typeHeader.onclick = () => { this.setView(type.id, 'type'); if(window.innerWidth < 768) this.toggleSidebar(); };
                    typeHeader.innerHTML = `
                        <span class="flex items-center gap-2">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg>
                            ${type.name}
                        </span>
                    `;
                    typeDiv.appendChild(typeHeader);

                    // Folders under Type
                    const folderList = document.createElement('div');
                    folderList.className = "ml-4 border-l border-slate-700 space-y-1 mt-1";
                    
                    typeFolders.forEach(f => {
                        const count = this.state.items.filter(i => i.folderId === f.id).length;
                        const isFolderActive = this.state.currentView === f.id && this.state.currentViewType === 'folder';
                        
                        const folderItem = document.createElement('div');
                        folderItem.className = `cursor-pointer px-3 py-1.5 rounded-r transition flex items-center justify-between group text-xs ${isFolderActive ? 'bg-blue-600 text-white border-l-2 border-blue-400' : 'hover:bg-slate-800 text-slate-400 hover:text-slate-200'}`;
                        folderItem.onclick = (e) => { 
                            e.stopPropagation(); 
                            this.setView(f.id, 'folder');
                            if(window.innerWidth < 768) this.toggleSidebar();
                        };
                        
                        let deleteBtnHtml = '';
                        if (this.state.isAuthenticated) {
                            deleteBtnHtml = `<button class="hidden group-hover:block ml-2 text-slate-500 hover:text-red-400 delete-folder-btn">&times;</button>`;
                        }

                        folderItem.innerHTML = `
                            <span class="truncate flex-1">${f.name}</span>
                            <span class="text-[10px] opacity-60">${count}</span>
                            ${deleteBtnHtml}
                        `;
                        
                        if (this.state.isAuthenticated) {
                            const btn = folderItem.querySelector('.delete-folder-btn');
                            if(btn) btn.onclick = (e) => { e.stopPropagation(); this.deleteFolder(f.id); };
                        }

                        folderList.appendChild(folderItem);
                    });
                    
                    if (typeFolders.length === 0) {
                        const empty = document.createElement('div');
                        empty.className = "ml-4 text-[10px] text-slate-600 italic py-1";
                        empty.textContent = "暂无资料夹";
                        folderList.appendChild(empty);
                    }

                    typeDiv.appendChild(folderList);
                    container.appendChild(typeDiv);
                });

                // Update 'All' active state
                const allNav = document.getElementById('nav-all');
                if (this.state.currentView === 'all') {
                    allNav.classList.add('bg-blue-600', 'text-white');
                    allNav.classList.remove('hover:bg-slate-700');
                    document.getElementById('count-all').classList.add('text-blue-200', 'bg-blue-700');
                } else {
                    allNav.classList.remove('bg-blue-600', 'text-white');
                    allNav.classList.add('hover:bg-slate-700');
                    document.getElementById('count-all').classList.remove('text-blue-200', 'bg-blue-700');
                }
            }

            renderTable() {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                
                let filtered = this.state.items;
                const isAuth = this.state.isAuthenticated;

                // Toggle Table Headers
                const thead = document.querySelector('thead tr');
                if (thead) {
                    // Checkbox Column (First)
                    thead.firstElementChild.style.display = isAuth ? 'table-cell' : 'none';
                    // Actions Column (Last)
                    thead.lastElementChild.style.display = isAuth ? 'table-cell' : 'none';
                }
                
                // Filter by folder or type
                if (this.state.currentView !== 'all') {
                    if (this.state.currentViewType === 'folder') {
                        filtered = filtered.filter(i => i.folderId === this.state.currentView);
                        const folder = this.state.folders.find(f => f.id === this.state.currentView);
                        document.getElementById('page-title').textContent = folder ? folder.name : '未知资料夹';
                    } else if (this.state.currentViewType === 'type') {
                        filtered = filtered.filter(i => i.typeId === this.state.currentView);
                        const type = this.state.types.find(t => t.id === this.state.currentView);
                        document.getElementById('page-title').textContent = type ? `分类: ${type.name}` : '未知分类';
                    }
                } else {
                    document.getElementById('page-title').textContent = '所有藏品';
                }

                // Filter by Search
                if (this.state.searchQuery) {
                    const q = this.state.searchQuery.toLowerCase();
                    filtered = filtered.filter(i => 
                        i.name.toLowerCase().includes(q) || 
                        i.code.toLowerCase().includes(q)
                    );
                }

                if (filtered.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                } else {
                    document.getElementById('empty-state').classList.add('hidden');
                }

                filtered.forEach(item => {
                    const type = this.state.types.find(t => t.id === item.typeId);
                    const typeName = type ? type.name : '-';
                    const isSelected = this.state.selectedItems.has(item.id);
                    const imageCount = item.images ? item.images.length : 0;
                    const firstImage = imageCount > 0 ? item.images[0] : null;

                    const tr = document.createElement('tr');
                    tr.className = `border-b border-slate-50 hover:bg-slate-50 transition ${isSelected ? 'bg-blue-50' : ''} cursor-pointer hover:bg-blue-50/50`;
                    tr.onclick = () => app.viewItem(item.id);
                    
                    const currency = this.state.currencies.find(c => c.id === item.currencyId);
                    const currencyName = currency ? currency.name : '-';
                    const faceValue = item.faceValue || '-';

                    tr.innerHTML = `
                        <td class="p-4" style="${isAuth ? '' : 'display:none'}" onclick="event.stopPropagation()"><input type="checkbox" onchange="app.toggleSelection('${item.id}')" ${isSelected ? 'checked' : ''} class="rounded text-blue-600 focus:ring-blue-500"></td>
                        <td class="p-4 font-mono text-xs text-slate-400">${item.code}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                ${firstImage ? `<img src="${firstImage}" class="w-10 h-10 object-cover rounded border border-slate-200 bg-white">` : `<div class="w-10 h-10 bg-slate-100 rounded flex items-center justify-center text-[10px] text-slate-300">无图</div>`}
                                <span class="text-xs font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded">${imageCount}图</span>
                            </div>
                        </td>
                        <td class="p-4 font-medium text-slate-800">${item.name}</td>
                        <td class="p-4 text-xs">
                            <div class="font-bold text-slate-700">${faceValue}</div>
                            <div class="text-slate-400 text-[10px]">${currencyName}</div>
                        </td>
                        <td class="p-4"><span class="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600">${typeName}</span></td>
                        <td class="p-4 text-right font-mono text-amber-600 font-bold">${item.price ? Number(item.price).toLocaleString() : '-'}</td>
                        <td class="p-4 text-slate-500">${item.prodDate || '-'}</td>
                        <td class="p-4 text-slate-500">${item.date || '-'}</td>
                        <td class="p-4 text-slate-500 truncate max-w-[150px]" title="${item.note || ''}">${item.note || ''}</td>
                        <td class="p-4 text-right space-x-2" style="${isAuth ? '' : 'display:none'}">
                            <button onclick="event.stopPropagation(); app.editItem('${item.id}')" class="bg-slate-100 hover:bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-medium transition">编辑</button>
                            <button onclick="event.stopPropagation(); app.deleteItem('${item.id}')" class="bg-slate-100 hover:bg-red-100 text-red-500 px-2 py-1 rounded text-xs font-medium transition">删除</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                // Update Batch Bar
                const batchBar = document.getElementById('batch-bar');
                if (this.state.selectedItems.size > 0 && isAuth) {
                    batchBar.classList.remove('hidden');
                    document.getElementById('selected-count').textContent = this.state.selectedItems.size;
                } else {
                    batchBar.classList.add('hidden');
                }
            }

            renderStats() {
                document.getElementById('count-all').textContent = this.state.items.length;
            }

            // --- Logic ---

            setView(viewId, viewType) {
                this.state.currentView = viewId;
                this.state.currentViewType = viewType;
                this.state.selectedItems.clear(); // Clear selection on view change
                this.renderAll();
            }

            handleSearch(val) {
                this.state.searchQuery = val;
                this.renderTable();
            }

            getUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }

            generateCode() {
                // Generate a readable code like A-20231027
                const date = new Date().toISOString().slice(0,10).replace(/-/g,'');
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `C${date}-${random}`;
            }

            // --- Items ---

            viewItem(id) {
                const item = this.state.items.find(i => i.id === id);
                if (!item) return;

                const type = this.state.types.find(t => t.id === item.typeId);
                const folder = this.state.folders.find(f => f.id === item.folderId);
                const currency = this.state.currencies.find(c => c.id === item.currencyId);

                // Populate Fields
                document.getElementById('detail-title').textContent = item.name;
                document.getElementById('detail-name').textContent = item.name;
                document.getElementById('detail-code').textContent = item.code;
                document.getElementById('detail-type').textContent = type ? type.name : '未分类';
                document.getElementById('detail-folder').textContent = folder ? folder.name : '无';
                document.getElementById('detail-price').textContent = item.price ? Number(item.price).toLocaleString() : '未估价';
                
                const faceValue = item.faceValue || '-';
                const currName = currency ? currency.name : '';
                document.getElementById('detail-value').textContent = faceValue + (currName ? ` / ${currName}` : '');
                
                document.getElementById('detail-prod-date').textContent = item.prodDate || '-';
                document.getElementById('detail-date').textContent = item.date || '-';
                document.getElementById('detail-note').textContent = item.note || '无备注';

                // Images
                const imgContainer = document.getElementById('detail-images');
                imgContainer.innerHTML = '';
                if (item.images && item.images.length > 0) {
                    item.images.forEach(url => {
                        const img = document.createElement('img');
                        img.src = url;
                        img.className = "h-48 md:h-64 object-contain bg-slate-100 rounded border border-slate-200 shadow-sm shrink-0";
                        img.onerror = () => { img.src = 'https://via.placeholder.com/300?text=Image+Error'; };
                        // Click to view larger? (Optional, browsers handle image drag/open)
                        imgContainer.appendChild(img);
                    });
                } else {
                    imgContainer.innerHTML = `<div class="w-full h-32 bg-slate-50 flex items-center justify-center text-slate-400 text-sm rounded border border-slate-100 italic">暂无图片</div>`;
                }

                document.getElementById('detail-modal').classList.add('active');
            }

            openItemModal(itemId = null) {
                const modal = document.getElementById('item-modal');
                const form = document.getElementById('item-form');
                form.reset();
                this.state.tempImages = [];

                // Populate Dropdowns
                const typeSelect = document.getElementById('item-type');
                typeSelect.innerHTML = this.state.types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                
                const folderSelect = document.getElementById('item-folder');
                folderSelect.innerHTML = `<option value="">(无资料夹)</option>` + 
                    this.state.folders.map(f => {
                        const type = this.state.types.find(t => t.id === f.typeId);
                        return `<option value="${f.id}">${type ? type.name + ' > ' : ''}${f.name}</option>`;
                    }).join('');

                const currencySelect = document.getElementById('item-currency');
                currencySelect.innerHTML = this.state.currencies.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                if (itemId) {
                    // Edit Mode
                    const item = this.state.items.find(i => i.id === itemId);
                    document.getElementById('item-modal-title').textContent = '编辑藏品';
                    document.getElementById('item-id-hidden').value = item.id;
                    document.getElementById('item-name').value = item.name;
                    document.getElementById('item-code').value = item.code;
                    document.getElementById('item-face-value').value = item.faceValue || '';
                    currencySelect.value = item.currencyId || '';
                    document.getElementById('item-price').value = item.price;
                    document.getElementById('item-prod-date').value = item.prodDate || '';
                    document.getElementById('item-date').value = item.date;
                    document.getElementById('item-note').value = item.note;
                    typeSelect.value = item.typeId;
                    folderSelect.value = item.folderId;
                    this.state.tempImages = [...(item.images || [])];
                } else {
                    // Create Mode
                    document.getElementById('item-modal-title').textContent = '新增藏品';
                    document.getElementById('item-id-hidden').value = '';
                    document.getElementById('item-code').value = this.generateCode();
                    document.getElementById('item-face-value').value = '';
                    document.getElementById('item-prod-date').value = '';
                    document.getElementById('item-date').value = new Date().toISOString().split('T')[0];
                    
                    // Auto-select folder or type if viewing one
                    if (this.state.currentView !== 'all') {
                        if (this.state.currentViewType === 'folder') {
                            const folder = this.state.folders.find(f => f.id === this.state.currentView);
                            if(folder) {
                                folderSelect.value = this.state.currentView;
                                typeSelect.value = folder.typeId;
                            }
                        } else if (this.state.currentViewType === 'type') {
                            typeSelect.value = this.state.currentView;
                        }
                    }
                }

                this.renderTempImages();
                modal.classList.add('active');
            }

            renderTempImages() {
                const container = document.getElementById('image-preview-container');
                const counter = document.getElementById('image-counter');
                container.innerHTML = '';
                
                this.state.tempImages.forEach((url, index) => {
                    const div = document.createElement('div');
                    div.className = "relative aspect-square group bg-white border border-slate-200 rounded overflow-hidden shadow-sm hover:shadow-md transition";
                    div.innerHTML = `
                        <img src="${url}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/150?text=Invalid+URL'">
                        <button onclick="app.removeImageUrl(${index})" class="absolute top-1 right-1 bg-red-500 text-white w-5 h-5 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-lg text-xs">&times;</button>
                    `;
                    container.appendChild(div);
                });
                
                counter.textContent = `已添加: ${this.state.tempImages.length} / 25`;
            }

            addImageUrl() {
                const input = document.getElementById('image-url-input');
                const url = input.value.trim();
                if (!url) return;
                
                if (this.state.tempImages.length >= 25) {
                    alert('最多只能添加 25 张图片');
                    return;
                }
                
                this.state.tempImages.push(url);
                input.value = '';
                this.renderTempImages();
            }

            removeImageUrl(index) {
                this.state.tempImages.splice(index, 1);
                this.renderTempImages();
            }

            saveItem(e) {
                e.preventDefault();
                const id = document.getElementById('item-id-hidden').value;
                const newItem = {
                    id: id || this.getUniqueId(),
                    name: document.getElementById('item-name').value,
                    code: document.getElementById('item-code').value || this.generateCode(),
                    typeId: document.getElementById('item-type').value,
                    folderId: document.getElementById('item-folder').value,
                    currencyId: document.getElementById('item-currency').value,
                    faceValue: document.getElementById('item-face-value').value,
                    price: document.getElementById('item-price').value,
                    prodDate: document.getElementById('item-prod-date').value,
                    date: document.getElementById('item-date').value,
                    note: document.getElementById('item-note').value,
                    images: [...this.state.tempImages]
                };

                if (id) {
                    const idx = this.state.items.findIndex(i => i.id === id);
                    this.state.items[idx] = newItem;
                } else {
                    this.state.items.push(newItem);
                }

                this.saveData();
                this.closeModal('item-modal');
            }

            deleteItem(id) {
                if(confirm('确定要删除这个藏品吗？')) {
                    this.state.items = this.state.items.filter(i => i.id !== id);
                    this.state.selectedItems.delete(id);
                    this.saveData();
                }
            }

            editItem(id) {
                this.openItemModal(id);
            }

            // --- Folders ---

            openFolderModal() {
                const typeSelect = document.getElementById('folder-parent-type');
                typeSelect.innerHTML = this.state.types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                
                // If currently viewing a type, auto-select it
                if (this.state.currentViewType === 'type') {
                    typeSelect.value = this.state.currentView;
                }

                document.getElementById('folder-name').value = '';
                document.getElementById('folder-desc').value = '';
                document.getElementById('folder-modal').classList.add('active');
            }

            saveFolder(e) {
                e.preventDefault();
                const typeId = document.getElementById('folder-parent-type').value;
                if (!typeId) {
                    alert('请选择分类');
                    return;
                }
                const newFolder = {
                    id: this.getUniqueId(),
                    typeId: typeId,
                    name: document.getElementById('folder-name').value,
                    description: document.getElementById('folder-desc').value
                };
                this.state.folders.push(newFolder);
                this.saveData();
                this.closeModal('folder-modal');
                // Optional: switch view to new folder
                this.setView(newFolder.id, 'folder');
            }

            deleteFolder(id) {
                if(confirm('删除资料夹不会删除里面的藏品，它们将变为"未分类"。确定删除？')) {
                    this.state.folders = this.state.folders.filter(f => f.id !== id);
                    // Reset items in this folder
                    this.state.items.forEach(i => {
                        if (i.folderId === id) i.folderId = '';
                    });
                    if (this.state.currentView === id && this.state.currentViewType === 'folder') {
                        this.setView('all', 'all');
                    }
                    this.saveData();
                }
            }

            deleteFolderFromSettings(id) {
                if(confirm('删除资料夹不会删除里面的藏品，它们将变为"未分类"。确定删除？')) {
                    this.state.folders = this.state.folders.filter(f => f.id !== id);
                    // Reset items in this folder
                    this.state.items.forEach(i => {
                        if (i.folderId === id) i.folderId = '';
                    });
                    if (this.state.currentView === id && this.state.currentViewType === 'folder') {
                        this.setView('all', 'all');
                    }
                    this.saveData();
                    this.openTypeSettings();
                }
            }

            // --- Types ---

            openTypeSettings() {
                const modal = document.getElementById('settings-modal');
                
                // Render Types
                const typeBody = document.getElementById('type-list-body');
                typeBody.innerHTML = '';
                this.state.types.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 font-medium">${t.name}</td>
                        <td class="p-3 text-slate-500">${t.note || '-'}</td>
                        <td class="p-3 text-right">
                            <button onclick="app.deleteType('${t.id}')" class="text-red-500 hover:text-red-700 text-xs">删除</button>
                        </td>
                    `;
                    typeBody.appendChild(tr);
                });

                // Render Folders
                const folderBody = document.getElementById('folder-list-body');
                if (folderBody) {
                    folderBody.innerHTML = '';
                    this.state.folders.forEach(f => {
                        const type = this.state.types.find(t => t.id === f.typeId);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="p-3 font-medium">${f.name}</td>
                            <td class="p-3 text-slate-500">${type ? type.name : '-'}</td>
                            <td class="p-3 text-right">
                                <button onclick="app.deleteFolderFromSettings('${f.id}')" class="text-red-500 hover:text-red-700 text-xs">删除</button>
                            </td>
                        `;
                        folderBody.appendChild(tr);
                    });
                }

                // Render Currencies
                const currencyBody = document.getElementById('currency-list-body');
                currencyBody.innerHTML = '';
                this.state.currencies.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3 font-medium">${c.name}</td>
                        <td class="p-3 text-right">
                            <button onclick="app.deleteCurrency('${c.id}')" class="text-red-500 hover:text-red-700 text-xs">删除</button>
                        </td>
                    `;
                    currencyBody.appendChild(tr);
                });

                modal.classList.add('active');
            }

            addCurrency(e) {
                e.preventDefault();
                const name = document.getElementById('new-currency-name').value;
                if(name) {
                    this.state.currencies.push({
                        id: this.getUniqueId(),
                        name
                    });
                    document.getElementById('new-currency-name').value = '';
                    this.openTypeSettings(); // refresh list
                    this.saveData();
                }
            }

            deleteCurrency(id) {
                const used = this.state.items.some(i => i.currencyId === id);
                if (used) {
                    alert('无法删除：该币种正被藏品使用。');
                    return;
                }
                if (this.state.currencies.length <= 1) {
                    alert('请保留至少一个币种。');
                    return;
                }
                if(confirm('确定删除此币种吗？')) {
                    this.state.currencies = this.state.currencies.filter(c => c.id !== id);
                    this.saveData();
                    this.openTypeSettings();
                }
            }

            addType(e) {
                e.preventDefault();
                const name = document.getElementById('new-type-name').value;
                const note = document.getElementById('new-type-note').value;
                if(name) {
                    this.state.types.push({
                        id: this.getUniqueId(),
                        name, note
                    });
                    document.getElementById('new-type-name').value = '';
                    document.getElementById('new-type-note').value = '';
                    this.openTypeSettings(); // refresh list
                    this.saveData();
                }
            }

            deleteType(id) {
                // Check usage in items or folders
                const usedInItems = this.state.items.some(i => i.typeId === id);
                const usedInFolders = this.state.folders.some(f => f.typeId === id);
                
                if (usedInItems || usedInFolders) {
                    alert('无法删除：该分类正被藏品或资料夹使用。');
                    return;
                }
                
                if (this.state.types.length <= 1) {
                    alert('系统必须保留至少一个分类。');
                    return;
                }

                if(confirm('确定删除此分类吗？')) {
                    this.state.types = this.state.types.filter(t => t.id !== id);
                    if (this.state.currentView === id && this.state.currentViewType === 'type') {
                        this.setView('all', 'all');
                    }
                    this.saveData();
                    this.openTypeSettings();
                }
            }

            // --- Batch Operations ---

            toggleSelection(id) {
                if (this.state.selectedItems.has(id)) {
                    this.state.selectedItems.delete(id);
                } else {
                    this.state.selectedItems.add(id);
                }
                this.updateBatchUI();
            }

            toggleSelectAll(checkbox) {
                const visibleIds = this.getVisibleItems().map(i => i.id);
                if (checkbox.checked) {
                    visibleIds.forEach(id => this.state.selectedItems.add(id));
                } else {
                    this.state.selectedItems.clear();
                }
                this.renderTable(); 
            }

            getVisibleItems() {
                let items = this.state.items;
                if (this.state.currentView !== 'all') {
                    if (this.state.currentViewType === 'folder') {
                        items = items.filter(i => i.folderId === this.state.currentView);
                    } else if (this.state.currentViewType === 'type') {
                        items = items.filter(i => i.typeId === this.state.currentView);
                    }
                }
                if (this.state.searchQuery) {
                    const q = this.state.searchQuery.toLowerCase();
                    items = items.filter(i => 
                        i.name.toLowerCase().includes(q) || 
                        i.code.toLowerCase().includes(q)
                    );
                }
                return items;
            }

            updateBatchUI() {
                this.renderTable();
                
                // Update folder dropdown
                const folderSelect = document.getElementById('batch-folder-select');
                if (folderSelect) {
                    folderSelect.innerHTML = `<option value="">-- 移动到 --</option>` + 
                        this.state.folders.map(f => `<option value="${f.id}">${f.name}</option>`).join('');
                }

                // Update type dropdown
                const typeSelect = document.getElementById('batch-type-select');
                if (typeSelect) {
                    typeSelect.innerHTML = `<option value="">-- 修改类型 --</option>` + 
                        this.state.types.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                }
            }

            clearSelection() {
                this.state.selectedItems.clear();
                this.renderTable();
            }

            batchDelete() {
                if (confirm(`确定删除选中的 ${this.state.selectedItems.size} 个藏品吗？`)) {
                    this.state.items = this.state.items.filter(i => !this.state.selectedItems.has(i.id));
                    this.clearSelection();
                    this.saveData();
                }
            }

            batchSetType() {
                const typeId = document.getElementById('batch-type-select').value;
                if (!typeId) return;
                
                this.state.items.forEach(i => {
                    if (this.state.selectedItems.has(i.id)) {
                        i.typeId = typeId;
                    }
                });
                this.clearSelection();
                this.saveData();
            }

            batchMove() {
                const targetFolderId = document.getElementById('batch-folder-select').value;
                if (!targetFolderId) return;
                
                this.state.items.forEach(i => {
                    if (this.state.selectedItems.has(i.id)) {
                        i.folderId = targetFolderId;
                    }
                });
                this.clearSelection();
                this.saveData();
            }

            // --- Utils ---
            closeModal(id) {
                document.getElementById(id).classList.remove('active');
            }
        }

        const app = new App();
    </script>
</body>
</html>
